---
# Windows Metrics Collection Playbook
# Collects CPU, Memory, Disk, and Network metrics from Windows servers

- name: Collect Windows System Metrics
  hosts: windows
  gather_facts: yes
  
  tasks:
    - name: Get system ID from API
      uri:
        url: "{{ api_url }}/systems/?name={{ inventory_hostname }}"
        method: GET
        return_content: yes
      register: system_response
      delegate_to: localhost
      changed_when: false
    
    - name: Register system if not exists
      uri:
        url: "{{ api_url }}/systems/"
        method: POST
        body_format: json
        body:
          name: "{{ inventory_hostname }}"
          type: "windows"
          ip_address: "{{ ansible_host }}"
          version: "{{ ansible_os_family }} {{ ansible_distribution_version }}"
          ansible_user: "{{ ansible_user }}"
          ansible_port: "{{ ansible_port }}"
          ansible_connection: "{{ ansible_connection }}"
        status_code: [201, 400]
      delegate_to: localhost
      when: system_response.json | length == 0
      register: register_response
    
    - name: Set system_id fact
      set_fact:
        system_id: "{{ (system_response.json[0].id if system_response.json | length > 0 else register_response.json.id) | int }}"
    
    - name: Get CPU usage
      win_shell: |
        (Get-Counter '\Processor(_Total)\% Processor Time').CounterSamples.CookedValue
      register: cpu_usage
    
    - name: Get Memory usage
      win_shell: |
        $os = Get-WmiObject Win32_OperatingSystem
        $totalMemory = $os.TotalVisibleMemorySize
        $freeMemory = $os.FreePhysicalMemory
        $usedMemory = $totalMemory - $freeMemory
        [math]::Round(($usedMemory / $totalMemory) * 100, 2)
      register: memory_usage
    
    - name: Get Disk usage
      win_shell: |
        $disk = Get-WmiObject Win32_LogicalDisk -Filter "DeviceID='C:'"
        [math]::Round((($disk.Size - $disk.FreeSpace) / $disk.Size) * 100, 2)
      register: disk_usage
    
    - name: Get Network stats
      win_shell: |
        $net = Get-NetAdapterStatistics | Select-Object -First 1
        "$($net.ReceivedBytes / 1KB) $($net.SentBytes / 1KB)"
      register: network_stats
    
    - name: Send metrics to API
      uri:
        url: "{{ api_url }}/metrics/"
        method: POST
        body_format: json
        body:
          system_id: "{{ system_id }}"
          cpu_usage: "{{ cpu_usage.stdout | trim | float }}"
          memory_usage: "{{ memory_usage.stdout | trim | float }}"
          disk_usage: "{{ disk_usage.stdout | trim | float }}"
          network_in: "{{ network_stats.stdout.split()[0] | float }}"
          network_out: "{{ network_stats.stdout.split()[1] | float }}"
        status_code: 201
      delegate_to: localhost
    
    - name: Create log entry
      uri:
        url: "{{ api_url }}/logs/"
        method: POST
        body_format: json
        body:
          system_id: "{{ system_id }}"
          level: "info"
          message: "Metrics collected successfully"
          source: "ansible"
        status_code: 201
      delegate_to: localhost
